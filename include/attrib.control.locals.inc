<?php
// control attribute plugin for
// locals (which domains should be treated as locals)
//
// $Id: attrib.control.locals.inc,v 2.0 2002-12-13 14:34:58 turbo Exp $

function locals_check($type){
    global $error, $locals;
    
    // check validity
    if(is_array($locals)){
	foreach($locals as $key => $host){
	    if($host == ""){
		continue;
	    }
	    
	    if(!check_hostaddress($host)){
		$error["locals_$key"] = PQL_INVALID;
		$is_error = true;
	    }
	    
	} // end foreach
    } // end if is_array

    if($is_error){
	return false;
    }
    
    return true;
}

function locals_init(){
    // init values
    global $_pql_control, $locals;
    
    // fetch data from ldap server
    $locals = pql_control_get_attribute($_pql_control->ldap_linkid, PQL_LDAP_CONTROL_BASEDN, "locals");
    
    if(is_null($locals)){
	return true;
    }
}

function locals_print_view(){
    global $_pql_control, $locals;
    
    // init data
    locals_init();
  ?>
  <table cellspacing="0" cellpadding="3" border="0">
    <th align="left">locals (Defined locals)</th>
      <tr class="title"><td>Domain</td></tr>
  <?php
    if(!is_array($locals)){
  ?>
      <tr class="<?php table_bgcolor(); ?>"><td>no locals defined</td></tr>
  <?php
    } else {
	asort($locals);
	foreach($locals as $localdomain){
  ?>
      <tr class="<?php table_bgcolor(); ?>"><td><?php echo $localdomain; ?></td></tr>
  <?php
        } // end foreach
    } // end if is_array

    if(PQL_LDAP_CONTROL_AUTOADDLOCALS){
  ?>
      <tr class="subtitle">
        <td><img src="images/info.png" width="16" height="16" border="0">These values will be automatically generated by phpQLAdmin, and cannot be edited.
		If you want to do it by yourself eg. to control more than one qmail-ldap server, disable PQL_LDAP_CONTROL_AUTOADDLOCALS in the config file.</td>
      </tr>
      <tr class="subtitle">
        <td><a href="control_edit_attribute.php?attrib=locals&type=replicate&submit=1"><img src="images/edit.png" width="12" height="12" border="0" alt="replicate">Click here to start replication manually</a></td>
      </tr>
  <?php
    } else {
  ?>
      <tr class="subtitle">
        <td><a href="control_edit_attribute.php?attrib=locals"><img src="images/edit.png" width="12" height="12" border="0"> change options</a> (The automatic replication with domain is disabled)</td>
      </tr>
    </th>
	<?php }	?>
  </table>
  <?php
}

function locals_print_form(){
    global $attrib, $PHP_SELF, $error, $locals, $localcount;
    
    // if automatic replication is enabled, don't display form
    if(PQL_LDAP_CONTROL_AUTOADDLOCALS){
	return false;
    }
    
    if(($localcount < count($locals) - 1) and count($locals) != 0){
	$localcount = count($locals) - 1;
    }
    
  ?>
	<form action="<?php echo $PHP_SELF ?>" method="post">
	<table cellspacing="0" cellpadding="3" border="0">
	<th colspan="3" align="left">locals (defined locals)</th>
	<tr class="title">
		<td>Hosts</td>
	</tr>
	<tr class="<?php table_bgcolor(); ?>">
		<td><?php echo format_error($error["locals_0"]); ?><input type="text" name="locals[0]" value="<?php echo $locals[0]; ?>"></td>
	</tr>
	<?php for($i = 1; $i <= $localcount; $i++){ ?>
	<tr class="<?php table_bgcolor(); ?>">
		<td><?php echo format_error($error["locals_$i"]); ?><input type="text" name="locals[<?php echo $i; ?>]" value="<?php echo $locals[$i]; ?>"></td>
	</tr>
	<?php } ?>
	<tr class="subtitle">
		<td><a href="<?php echo $PHP_SELF; ?>?attrib=<?php echo $attrib; ?>&localcount=<?php echo ($localcount + 1); ?>">add additional address</a> (please save first, changes will be lost)</td>
	</tr>
	<tr class="subtitle">
		<td><img src="images/info.png" width="16" height="16" border="0">To delete an address remove the value and save.
		</td>
	</tr>
	</table>
	<input type="hidden" name="submit" value="1">
	<input type="hidden" name="attrib" value="<?php echo $attrib; ?>">
	<br>
	<br>
	<input type="submit" value="<?php echo PQL_SAVE; ?>">
	</form>
  <?php
}

function locals_save($type){
    global $_pql, $_pql_control, $attrib, $locals, $set, $error;
    
    // recontrol values
    if(!locals_check($type)){
	return false;
    }
    
    switch($type){
      case "replicate":
	// start replication manually
	if(pql_control_update_domains($_pql->ldap_linkid, PQL_LDAP_BASEDN, $_pql_control->ldap_linkid, PQL_LDAP_CONTROL_BASEDN)){
	    $msg = "Successfully replicated locals";
    	} else {
	    $msg = "Failed replicating locals: " . pql_ldap_error($_pql_control->ldap_linkid);
    	}
	
	attribute_forward($msg);
	break;
	
      case "del":
	// delete entry
	
	// adding specified domain to rcpthosts, redirect back to domain details
	if(pql_control_remove_attribute($_pql_control->ldap_linkid, PQL_LDAP_CONTROL_BASEDN, "locals", $set)){
	    $msg = "Successfully removed $set from locals";
	} else {
	    $msg = "Failed removing $set from locals: " . pql_ldap_error($_pql_control->ldap_linkid);
    	}
	
	$msg = urlencode($msg);
	header("Location: " . PQL_URI . "domain_detail.php?domain=$set&msg=$msg");
	
	break;
      case "add":
	// add entry
	
	// adding specified domain to rcpthosts, redirect back to domain details
	if(pql_control_add_attribute($_pql_control->ldap_linkid, PQL_LDAP_CONTROL_BASEDN, "locals", $set)){
	    $msg = "Successfully added $set to locals";
	} else {
	    $msg = "Failed adding $set to locals: " . pql_ldap_error($_pql_control->ldap_linkid);
    	}
	
	$msg = urlencode($msg);
	header("Location: " . PQL_URI . "domain_detail.php?domain=$set&msg=$msg");
	
	break;
      case "modify":
	// save entries
	
	if(pql_control_replace_attribute($_pql_control->ldap_linkid, PQL_LDAP_CONTROL_BASEDN, "locals", $locals)){
	    $msg = "Successfully saved locals";
	} else {
	    $msg = "Failed saving locals: " . pql_ldap_error($_pql_control->ldap_linkid);
    	}
	
	attribute_forward($msg);
	break;
      default:
	die("unknown save type $type in " . __FILE__ . ", function save()");
    }
}

function locals_help(){
?>
List of domain names that the current host receives
mail for, one per line.  Default:  me, if that is
supplied; otherwise qmail-send refuses to run.  An
address user@domain is considered local if domain is
listed in locals.
<?php
}

function locals_help_cr(){
?>
	help text taken from qmail man pages
<?php
}

