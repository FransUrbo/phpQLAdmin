<?php
// control attribute plugin for
// locals (which domains should be treated as locals)
//
// $Id: attrib.control.locals.inc,v 2.14 2003-05-08 20:00:54 turbo Exp $

function locals_check($type){
    global $error, $locals, $rootdn, $domain;
    
    // check validity
    if(is_array($locals)){
		foreach($locals as $key => $host){
			if($host == ""){
				continue;
			}
			
			if(!check_hostaddress($host)){
				$error["locals_$key"] = PQL_LANG_INVALID;
				$is_error = true;
			}
			
		} // end foreach
    } // end if is_array
	
    if($is_error){
		return false;
    }
    
    return true;
}

// init values
function locals_init($host) {
    global $_pql_control, $locals;
    
    // fetch data from ldap server
    $locals = pql_control_get_attribute($_pql_control->ldap_linkid,
										"cn=" . $host . "," . $GLOBALS["USER_SEARCH_DN_CTR"],
										"locals");
    
    if(is_null($locals))
	  return true;
}

function locals_print_view($host) {
    global $_pql_control, $locals, $config;
    
    // init data
    locals_init($host);
?>
  <table cellspacing="0" cellpadding="3" border="0">
    <th align="left">locals (Defined locals) for host <u><?=$host?></u></th>
      <tr class="title"><td>Domain</td></tr>
<?php
    if(!is_array($locals)){
?>
      <tr class="<?php table_bgcolor(); ?>"><td>no locals defined</td></tr>
<?php
    } else {
		asort($locals);
		foreach($locals as $localdomain){
?>
      <tr class="<?php table_bgcolor(); ?>"><td><?php echo $localdomain; ?></td></tr>
<?php
        } // end foreach
    } // end if is_array

    if($config["PQL_GLOB_CONTROL_AUTOADDLOCALS"]) {
?>
      <tr class="subtitle">
        <td><a href="control_edit_attribute.php?attrib=locals&type=replicate&mxhost=<?=$host?>&submit=1"><img src="images/edit.png" width="12" height="12" border="0" alt="replicate">Click here to start replication manually</a></td>
      </tr>

      <br>

      <tr class="subtitle">
        <td>
          <table cellspacing="0" cellpadding="3" border="0">
            <tr>
              <td><img src="images/info.png" width="16" height="16" border="0"></td>
              <td>These values will be automatically generated by phpQLAdmin, and cannot be edited.<br>If you want to do it by yourself eg. to control more than one qmail-ldap server,<br>disable PQL_GLOB_CONTROL_AUTOADDLOCALS in the config file.</td>
            </tr>
          </table>
        </td>
      </tr>
  <?php
    } else {
  ?>
      <tr class="subtitle">
        <td><a href="control_edit_attribute.php?attrib=locals&mxhost=<?=$host?>"><img src="images/edit.png" width="12" height="12" border="0"> change options</a> (The automatic replication with domain is disabled)</td>
      </tr>
    </th>
	<?php }	?>
  </table>
  <?php
}

function locals_print_form(){
    global $attrib, $PHP_SELF, $error, $locals, $mxhost;
    
    // if automatic replication is enabled, don't display form
// BUG?
//    if($config["PQL_GLOB_CONTROL_AUTOADDLOCALS"]) {
//		return false;
//    }
?>
  <form action="<?php echo $PHP_SELF ?>" method="post">
    <table cellspacing="0" cellpadding="3" border="0">
      <th colspan="3" align="left">Add domain:</th>
        <tr class="<?php table_bgcolor(); ?>">
          <td><input type="text" name="set" size="30"></td>
        </tr>
      </th>
    </table>

    <input type="hidden" name="submit" value="1">
    <input type="hidden" name="attrib" value="<?php echo $attrib; ?>">
    <input type="hidden" name="mxhost" value="<?=$mxhost?>">
    <input type="submit" value="<?php echo PQL_LANG_SAVE; ?>">
  </form>
<?php
}

function locals_save($type, $host){
    global $_pql, $_pql_control, $attrib, $locals, $set, $error, $rootdn, $domain;

    switch($type) {
      case "replicate":
		// start replication manually

		if(pql_control_update_domains($_pql, "cn=$host,".$GLOBALS["USER_SEARCH_DN_CTR"], $host))
		  $msg = "Successfully replicated locals";
		else
		  $msg = "Failed replicating locals: " . pql_ldap_error($_pql_control->ldap_linkid);
	
		attribute_forward($msg);
		break;

      case "del":
		// remove specified domain from locals, redirect back to host details
		if(pql_control_update_domains($_pql_control, $GLOBALS["USER_SEARCH_DN_CTR"],
									  '*', array($set, ''), "locals"))
		  $msg = "Successfully removed $set from locals";
		else
		  $msg = "Failed removing $set from locals: " . pql_ldap_error($_pql_control->ldap_linkid);
		
		attribute_forward($msg);
		break;

      case "add":
		// adding specified domain to rcpthosts, redirect back to domain details
		if(pql_control_update_domains($_pql_control, $GLOBALS["USER_SEARCH_DN_CTR"],
									  '*', array('', $set), "locals"))
		  $msg = "Successfully added $set to locals";
		else
		  $msg = "Failed adding $set to locals: " . pql_ldap_error($_pql_control->ldap_linkid);
		
		attribute_forward($msg);
		break;

      default:
		die("unknown save type $type in " . __FILE__ . ", function save()");
    }
}

function locals_help(){
?>
List of domain names that the current host receives
mail for, one per line.  Default:  me, if that is
supplied; otherwise qmail-send refuses to run.  An
address user@domain is considered local if domain is
listed in locals.
<?php
}

function locals_help_cr(){
?>
	help text taken from qmail man pages
<?php
/*
 * Local variables:
 * mode: php
 * mode: font-lock
 * tab-width: 4
 * End:
 */
}

